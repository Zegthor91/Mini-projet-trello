<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
<link rel="stylesheet" href="style.css"/>
</head>
<body>
  <div x-data="trelloAppli()" x-init="init()">

    <h1>Mini Trello</h1>
    <p>Gestionnaire de taches</p>

    <h2 x-text="editingIndex !== null ? 'Modifier la tache' : 'Ajouter une tache'"></h2>
    <div>
        <label>Titre</label>
        <input type="text" x-model="newTask.title" @keyup.enter="editingIndex !== null ? updateTask() : addTask()">
    </div>
    <div>
        <label>Description</label>
        <textarea x-model="newTask.description"></textarea>
    </div>
    <div>
        <label>Statut</label>
        <select x-model="newTask.status">
        <option value="todo">A faire</option>
        <option value="working">En cours</option>
        <option value="completed">Terminé</option></select>
    </div>

    <div>
        <button @click="editingIndex !== null ? updateTask() : addTask()">
        <span x-text="editingIndex !== null ? 'Mettre a jour' : 'Ajouter'"></span></button>
        <button x-show="editingIndex !== null" @click="cancelEdit()">Annuler</button>
    </div>

    <div>
        <label>Rechercher par titre</label>
        <input type="text" x-model="search" placeholder="Recherche...">
    </div>

    <div>
        <button @click="$store.filter.current = 'all'">Tous (<span x-text="tasks.length"></span>)</button>
        <button @click="$store.filter.current = 'todo'">A faire (<span x-text="getTasksByStatus('todo').length"></span>)</button>
        <button @click="$store.filter.current = 'working'">En cours (<span x-text="getTasksByStatus('working').length"></span>)</button>
        <button @click="$store.filter.current = 'completed'">Terminés (<span x-text="getTasksByStatus('completed').length"></span>)</button>
    </div>

    <div>
        <template x-for="(task, i) in filteredTasks" :key="task.id">
            <div>
                <h3 x-text="task.title"></h3>
                <p x-text="getStatusLabel(task.status)"></p>
                <p x-text="task.description || 'Pas de description'"></p>
                <select :value="task.status" @change="changeStatus(task.id, $event.target.value)">
                    <option value="todo">A faire</option>
                    <option value="working">En cours</option>
                    <option value="completed">Terminé</option>
                </select>
                <button @click="editTask(task.id)">Modifier</button>
                <button @click="removeTask(task.id)">Supprimer</button>
             </div>
      </template>
    </div>
    <div x-show="filteredTasks.length === 0">
        <p>Aucune tache pour l'instant</p>
    </div>
  </div>

  <script>
    document.addEventListener('alpine:init', () => {

      Alpine.store('filter', { current: 'all' });

      Alpine.data('trelloAppli', () => ({
        tasks: [],
        newTask: { title: '', description: '', status: 'todo' },
        editingIndex: null,
        search: '',

        init() { this.loadTasks(); },

        addTask() {
          if (!this.newTask.title.trim()) return alert('Veuillez ajouter un titre');
          this.tasks.push({ 
            ...this.newTask, 
            id: Date.now()
          });
          this.saveTasks();
          this.resetForm();
        },

        editTask(id) {
          const taskIndex = this.tasks.findIndex(t => t.id === id);
          this.editingIndex = taskIndex;
          this.newTask = { ...this.tasks[taskIndex] };
          window.scrollTo({ top: 0, behavior: 'smooth' });
        },

        updateTask() {
          if (!this.newTask.title.trim()) return alert('Veuillez ajouter un titre');
          this.tasks[this.editingIndex] = { ...this.newTask };
          this.saveTasks();
          this.cancelEdit();
        },

        cancelEdit() {
          this.editingIndex = null;
          this.resetForm();
        },

        removeTask(id) {
          if (confirm('Etes-vous certain de supprimer cette tache ?')) {
            const taskIndex = this.tasks.findIndex(t => t.id === id);
            this.tasks.splice(taskIndex, 1);
            this.saveTasks();
          }
        },

        changeStatus(id, newStatus) {
          const task = this.tasks.find(t => t.id === id);
          task.status = newStatus;
          this.saveTasks();
        },

        resetForm() {
          this.newTask = { title: '', description: '', status: 'todo' };
        },

        saveTasks() {
          localStorage.setItem('trelloTasks', JSON.stringify(this.tasks));
        },

        loadTasks() {
          const saved = localStorage.getItem('trelloTasks');
          if (saved) this.tasks = JSON.parse(saved);
        },

        get filteredTasks() {
          const f = this.$store.filter.current;
          let filtered = f === 'all' ? this.tasks : this.tasks.filter(t => t.status === f);
          
          if (this.search.trim() !== '') {
            filtered = filtered.filter(t => 
              t.title.toLowerCase().includes(this.search.toLowerCase())
            );
          }
          
          return filtered;
        },

        getTasksByStatus(status) {
          return this.tasks.filter(t => t.status === status);
        },

        getStatusLabel(s) {
          return { 
            todo: 'A faire', 
            working: 'En cours', 
            completed: 'Terminé' 
          }[s] || s;
        }
      }));
    });
  </script>


</body>
</html>